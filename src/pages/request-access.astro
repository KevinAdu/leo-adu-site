---
import { useTranslations } from "../i18n/utils";

const tokenParam = Astro.url.searchParams.get("token") ?? "";
const expectedToken = import.meta.env.REQUEST_ACCESS_TOKEN ?? "";

if (!expectedToken || tokenParam !== expectedToken) {
  return Astro.redirect("/invite-only");
}

const acceptLanguage = Astro.request.headers.get("accept-language") ?? "";
const prefersJapanese = acceptLanguage.toLowerCase().includes("ja");
const lang = prefersJapanese ? "ja" : "en";
const i18n = useTranslations(lang);
const title = i18n("request.title");
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <title>{title}</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, sans-serif;
        background: #f7f3ea;
        color: #2b2b2b;
      }
      main {
        max-width: 720px;
        margin: 10vh auto;
        padding: 2rem;
        background: #fffdf7;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      form {
        display: grid;
        gap: 1rem;
      }
      .status {
        margin: 0;
        min-height: 1.25rem;
      }
      .status.error {
        color: #b43f2f;
      }
      .status.success {
        color: #2f6f3e;
      }
      label {
        display: grid;
        gap: 0.5rem;
        font-weight: 600;
      }
      input {
        padding: 0.6rem 0.7rem;
        border: 1px solid #d5cbb5;
        border-radius: 6px;
        font-size: 1rem;
      }
      fieldset {
        border: 1px solid #e5ddc7;
        border-radius: 8px;
        padding: 1rem;
      }
      legend {
        padding: 0 0.5rem;
        font-weight: 600;
      }
      button {
        padding: 0.7rem 1rem;
        border: none;
        border-radius: 6px;
        background: #7a5d2e;
        color: white;
        font-weight: 600;
        cursor: pointer;
      }
      .muted {
        color: #6b6558;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>{i18n("request.title")}</h1>
      <p class="muted">{i18n("request.subtitle")}</p>
      <form
        id="request-form"
        method="post"
        action="/api/access-requests"
        novalidate
        data-success-message={i18n("request.success")}
        data-error-message={i18n("request.error")}
      >
        <label>
          {i18n("request.first_name")}
          <input type="text" name="firstName" autocomplete="given-name" required />
        </label>
        <label>
          {i18n("request.last_name")}
          <input type="text" name="lastName" autocomplete="family-name" required />
        </label>
        <label>
          {i18n("request.email")}
          <input type="email" name="email" autocomplete="email" required />
        </label>
        <fieldset>
          <legend>{i18n("request.language_label")}</legend>
          <label>
            <input type="radio" name="language" value="en" checked={!prefersJapanese} />
            {i18n("request.language_en")}
          </label>
          <label>
            <input type="radio" name="language" value="ja" checked={prefersJapanese} />
            {i18n("request.language_ja")}
          </label>
        </fieldset>
        <input type="hidden" name="token" value={tokenParam} />
        <button type="submit">{i18n("request.submit")}</button>
        <p id="request-status" class="status success" role="status" aria-live="polite"></p>
        <p id="request-error" class="status error" role="alert" aria-live="polite"></p>
      </form>
    </main>

    <script type="module">
      const form = document.getElementById("request-form");
      const statusEl = document.getElementById("request-status");
      const errorEl = document.getElementById("request-error");
      if (!form) {
        console.error("Request access form not found.");
      } else {
        const submitButton = form.querySelector('button[type="submit"]');
        const messages = {
          success: form.dataset.successMessage || "Request submitted.",
          error: form.dataset.errorMessage || "Request failed.",
        };

        form.addEventListener("submit", async (event) => {
        event.preventDefault();
        statusEl.textContent = "";
        errorEl.textContent = "";
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.setAttribute("aria-busy", "true");
        }

        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        try {
          const response = await fetch("/api/access-requests", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const contentType = response.headers.get("content-type") || "";
          let data = null;
          if (contentType.includes("application/json")) {
            data = await response.json().catch(() => null);
          } else {
            const text = await response.text().catch(() => "");
            data = text ? { error: text } : null;
          }

          if (!response.ok) {
            errorEl.textContent = (data && data.error) || messages.error;
            return;
          }

          statusEl.textContent = (data && data.message) || messages.success;
          window.location.assign("/request-access/success");
        } catch (error) {
          errorEl.textContent = messages.error;
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.removeAttribute("aria-busy");
          }
        }
        });
      }
    </script>
  </body>
</html>
