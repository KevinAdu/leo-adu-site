---
const title = "Invite users";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <title>{title}</title>
  </head>
  <body>
    <main>
      <h1>{title}</h1>
      <p>
        <a href="/admin/requests">View access requests</a>
      </p>
      <form
        id="invite-form"
        data-success="Invite sent."
        data-failed="Invite failed."
      >
        <label>
          Email
          <input type="email" name="email" autocomplete="email" required />
        </label>
        <button type="submit">Send invite</button>
      </form>
      <p id="invite-error" role="alert"></p>
      <p id="invite-success" role="status"></p>
    </main>

    <script>
      const form = document.getElementById("invite-form");
      const errorEl = document.getElementById("invite-error");
      const successEl = document.getElementById("invite-success");

      if (!form) {
        console.error("Admin invite form not found.");
      } else {
        const messages = {
          success: form.dataset.success || "Invite sent.",
          failed: form.dataset.failed || "Invite failed.",
        };

        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (errorEl) {
            errorEl.textContent = "";
          }
          if (successEl) {
            successEl.textContent = "";
          }

          const formData = new FormData(form);
          const email = String(formData.get("email") || "");

          try {
            const response = await fetch("/api/auth/invite-user", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ email }),
            });

            const data = await response.json().catch(() => null);

            if (!response.ok) {
              if (errorEl) {
                errorEl.textContent = (data && data.message) || messages.failed;
              }
              return;
            }

            if (successEl) {
              successEl.textContent = messages.success;
            }
            form.reset();
          } catch (error) {
            if (errorEl) {
              errorEl.textContent = messages.failed;
            }
          }
        });
      }
    </script>
  </body>
</html>
