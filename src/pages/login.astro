---
import BaseHead from "../components/BaseHead.astro";

const title = "Sign in";
const description = "Sign in to access Leo Aduâ€™s private photo journal.";
const permalink = Astro.url.href;
const postAttempted = Astro.request.method === "POST";
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={title} {description} {permalink} />
  </head>
  <body>
    <main class="auth-layout">
      <section class="auth-card">
        <h1 class="h3">{title}</h1>
        <p class="auth-subtitle">
          Enter your email and password to continue.
        </p>
        <form id="login-form" class="auth-form" method="post" action="/login">
          <label class="auth-field">
            Email
            <input
              class="auth-input"
              type="email"
              name="email"
              autocomplete="email"
              required
            />
          </label>
          <label class="auth-field">
            Password
            <input
              class="auth-input"
              type="password"
              name="password"
              autocomplete="current-password"
              required
            />
          </label>
          <button class="auth-button" type="submit">Sign in</button>
        </form>
        {postAttempted ? (
          <p class="auth-error" role="alert">
            JavaScript is required to sign in.
          </p>
        ) : null}
        <p id="login-error" class="auth-error" role="alert"></p>
      </section>
    </main>

    <script>
      const form = document.getElementById("login-form");
      const errorEl = document.getElementById("login-error");

      if (form) {
        form.addEventListener("submit", async (event) => {
          event.preventDefault();
          if (errorEl) {
            errorEl.textContent = "";
          }

          const formData = new FormData(form);
          const email = String(formData.get("email") || "");
          const password = String(formData.get("password") || "");

          try {
            const response = await fetch("/api/auth/sign-in/email", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({ email, password, callbackURL: "/" }),
            });

            const data = await response.json().catch(() => null);

            if (!response.ok) {
              if (errorEl) {
                errorEl.textContent = (data && data.message) || "Sign-in failed.";
              }
              return;
            }

            if (data && data.url) {
              window.location.href = data.url;
              return;
            }

            window.location.href = "/";
          } catch (error) {
            if (errorEl) {
              errorEl.textContent = "Sign-in failed.";
            }
          }
        });
      }
    </script>
  </body>
</html>
